<div class="buffer-message">
  <div class="container">
      <div class="ball"></div>
      <div class="ball"></div>
      <div class="ball"></div>
      <div class="ball"></div>
      <div class="ball"></div>
      <div class="ball"></div>
      <div class="ball"></div>
  </div>
  <p class="lead">Chargement et récupération des sous-titres...</p>
</div>

<div class="watch">
  <a class="btn btn-success" href="<%= streamURL %>">Watch Now</a>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
  var streamURL = "<%= streamURL %>";
  var subs = <%- JSON.stringify(subtitles) %>;
  var torrent = "<%= decodeURIComponent(params.file) %>";

  var socket = io('/' + torrent);

  var languageMapping = {
    'albanian': 'sq',
    'arabic': 'ar',
    'bengali': 'bn',
    'brazilian-portuguese': 'pt-br',
    'bulgarian': 'bg',
    'bosnian': 'bs',
    'chinese': 'zh',
    'croatian': 'hr',
    'czech': 'cs',
    'danish': 'da',
    'dutch': 'nl',
    'english': 'en',
    'estonian': 'et',
    'farsi-persian': 'fa',
    'finnish': 'fi',
    'french': 'fr',
    'german': 'de',
    'greek': 'el',
    'hebrew': 'he',
    'hungarian': 'hu',
    'indonesian': 'id',
    'italian': 'it',
    'japanese': 'ja',
    'korean': 'ko',
    'lithuanian': 'lt',
    'macedonian': 'mk',
    'malay': 'ms',
    'norwegian': 'no',
    'polish': 'pl',
    'portuguese': 'pt',
    'romanian': 'ro',
    'russian': 'ru',
    'serbian': 'sr',
    'slovenian': 'sl',
    'spanish': 'es',
    'swedish': 'sv',
    'thai': 'th',
    'turkish': 'tr',
    'urdu': 'ur',
    'ukrainian': 'uk',
    'vietnamese': 'vi'
  };

  $(document).ready(function() {
    setTimeout(function(){
      var iOS = ( navigator.userAgent.match(/(iPad|iPhone|iPod)/g) ? true : false );

      if(torrent.search(/xvid/i) !==-1 ) {
        $('.buffer-message').hide();


        var video = '<br><p align="center">Cet épisode étant encodé en Xvid, il ne peut être joué dans un navigateur.';
        video += " Vous pouvez lire cet épisode avec VLC (ou un autre lecteur), en ouvrant l'adresse (Media>Ouvrir un flux résau): " + streamURL;
        video += "<br>Les sous-tires de cet épisodes peuvent être récupérés ici:<br>";
        for (var sub in subs) {
          video += "<a href=" + subs[sub] + ">" + sub + "</a>" + "<br>";
        }
        video += '</p>';
        $('.player').append(video);
      }
      else {
        if (iOS) {
          window.location.replace(streamURL);
        }
        else {
          $('.buffer-message').hide();

          var video = '<video id="player" class="video-js vjs-default-skin center-block" controls preload="auto" width="auto" height="auto" >';

          video += '<source src=' + streamURL + ' type="video/mp4">';

          for (var sub in subs) {
            video += '<track kind="subtitles" src=' + subs[sub] + ' srclang=' + languageMapping[sub] + ' label=' + sub + '>';
          }

          video +=  '/></video>';

          $('.player').append(video);
          _V_('player');
          _V_('player').play();
        }
      }
    }, 6000);
  });
</script>
